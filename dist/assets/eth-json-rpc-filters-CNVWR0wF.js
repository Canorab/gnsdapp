import{e as z}from"./eth-query-CTJIkvOv.js";import{c as W}from"./@metamask-D5jLp4R4.js";import{d as O}from"./json-rpc-engine-bI79XHen.js";import{l as Q}from"./async-mutex-C8K7s2QC.js";const A=(e,t,s,n)=>function(...i){const o=t.promiseModule;return new o((r,a)=>{t.multiArgs?i.push((...d)=>{t.errorFirst?d[0]?a(d):(d.shift(),r(d)):r(d)}):t.errorFirst?i.push((d,f)=>{d?a(d):r(f)}):i.push(r),Reflect.apply(e,this===s?n:this,i)})},N=new WeakMap;var q=(e,t)=>{t={exclude:[/.+(?:Sync|Stream)$/],errorFirst:!0,promiseModule:Promise,...t};const s=typeof e;if(!(e!==null&&(s==="object"||s==="function")))throw new TypeError(`Expected \`input\` to be a \`Function\` or \`Object\`, got \`${e===null?"null":s}\``);const n=(r,a)=>{let l=N.get(r);if(l||(l={},N.set(r,l)),a in l)return l[a];const d=m=>typeof m=="string"||typeof a=="symbol"?a===m:m.test(a),f=Reflect.getOwnPropertyDescriptor(r,a),y=f===void 0||f.writable||f.configurable,w=(t.include?t.include.some(d):!t.exclude.some(d))&&y;return l[a]=w,w},i=new WeakMap,o=new Proxy(e,{apply(r,a,l){const d=i.get(r);if(d)return Reflect.apply(d,a,l);const f=t.excludeMain?r:A(r,t,o,r);return i.set(r,f),Reflect.apply(f,a,l)},get(r,a){const l=r[a];if(!n(r,a)||l===Function.prototype[a])return l;const d=i.get(l);if(d)return d;if(typeof l=="function"){const f=A(l,t,o,r);return i.set(l,f),f}return l}});return o};const J=W.default;let V=class extends J{constructor(){super(),this.updates=[]}async initialize(){}async update(){throw new Error("BaseFilter - no update method specified")}addResults(t){this.updates=this.updates.concat(t),t.forEach(s=>this.emit("update",s))}addInitialResults(t){}getChangesAndClear(){const t=this.updates;return this.updates=[],t}};var v=V;const G=v;let K=class extends G{constructor(){super(),this.allResults=[]}async update(){throw new Error("BaseFilterWithHistory - no update method specified")}addResults(t){this.allResults=this.allResults.concat(t),super.addResults(t)}addInitialResults(t){this.allResults=this.allResults.concat(t),super.addInitialResults(t)}getAllResults(){return this.allResults}};var X=K,B={minBlockRef:Y,maxBlockRef:Z,sortBlockRefs:C,bnToHex:tt,blockRefIsNumber:et,hexToInt:$,incrementHexInt:st,intToHex:j,unsafeRandomBytes:nt};function Y(...e){return C(e)[0]}function Z(...e){const t=C(e);return t[t.length-1]}function C(e){return e.sort((t,s)=>t==="latest"||s==="earliest"?1:s==="latest"||t==="earliest"?-1:$(t)-$(s))}function tt(e){return"0x"+e.toString(16)}function et(e){return e&&!["earliest","latest","pending"].includes(e)}function $(e){return e==null?e:Number.parseInt(e,16)}function st(e){if(e==null)return e;const t=$(e);return j(t+1)}function j(e){if(e==null)return e;let t=e.toString(16);return t.length%2&&(t="0"+t),"0x"+t}function nt(e){let t="0x";for(let s=0;s<e;s++)t+=S(),t+=S();return t}function S(){return Math.floor(Math.random()*16).toString(16)}const rt=z,it=q,ot=X,{bnToHex:Xt,hexToInt:R,incrementHexInt:at,minBlockRef:ct,blockRefIsNumber:lt}=B;let ut=class extends ot{constructor({provider:t,params:s}){super(),this.type="log",this.ethQuery=new rt(t),this.params=Object.assign({fromBlock:"latest",toBlock:"latest",address:void 0,topics:[]},s),this.params.address&&(Array.isArray(this.params.address)||(this.params.address=[this.params.address]),this.params.address=this.params.address.map(n=>n.toLowerCase()))}async initialize({currentBlock:t}){let s=this.params.fromBlock;["latest","pending"].includes(s)&&(s=t),s==="earliest"&&(s="0x0"),this.params.fromBlock=s;const n=ct(this.params.toBlock,t),i=Object.assign({},this.params,{toBlock:n}),o=await this._fetchLogs(i);this.addInitialResults(o)}async update({oldBlock:t,newBlock:s}){const n=s;let i;t?i=at(t):i=s;const o=Object.assign({},this.params,{fromBlock:i,toBlock:n}),a=(await this._fetchLogs(o)).filter(l=>this.matchLog(l));this.addResults(a)}async _fetchLogs(t){return await it(n=>this.ethQuery.getLogs(t,n))()}matchLog(t){if(R(this.params.fromBlock)>=R(t.blockNumber)||lt(this.params.toBlock)&&R(this.params.toBlock)<=R(t.blockNumber))return!1;const s=t.address&&t.address.toLowerCase();return this.params.address&&s&&!this.params.address.includes(s)?!1:this.params.topics.every((i,o)=>{let r=t.topics[o];if(!r)return!1;r=r.toLowerCase();let a=Array.isArray(i)?i:[i];return a.includes(null)?!0:(a=a.map(f=>f.toLowerCase()),a.includes(r))})}};var dt=ut,E=ft;async function ft({provider:e,fromBlock:t,toBlock:s}){t||(t=s);const n=_(t),o=_(s)-n+1,r=Array(o).fill().map((l,d)=>n+d).map(pt);let a=await Promise.all(r.map(l=>mt(e,"eth_getBlockByNumber",[l,!1])));return a=a.filter(l=>l!==null),a}function _(e){return e==null?e:Number.parseInt(e,16)}function pt(e){return e==null?e:"0x"+e.toString(16)}function ht(e,t){return new Promise((s,n)=>{e.sendAsync(t,(i,o)=>{i?n(i):o.error?n(o.error):o.result?s(o.result):n(new Error("Result was empty"))})})}async function mt(e,t,s){for(let n=0;n<3;n++)try{return await ht(e,{id:1,jsonrpc:"2.0",method:t,params:s})}catch(i){console.error(`provider.sendAsync failed: ${i.stack||i.message||i}`)}return null}const yt=v,wt=E,{incrementHexInt:gt}=B;let Ft=class extends yt{constructor({provider:t,params:s}){super(),this.type="block",this.provider=t}async update({oldBlock:t,newBlock:s}){const n=s,i=gt(t),r=(await wt({provider:this.provider,fromBlock:i,toBlock:n})).map(a=>a.hash);this.addResults(r)}};var bt=Ft;const xt=v,Bt=E,{incrementHexInt:Rt}=B;let Lt=class extends xt{constructor({provider:t}){super(),this.type="tx",this.provider=t}async update({oldBlock:t}){const s=t,n=Rt(t),i=await Bt({provider:this.provider,fromBlock:n,toBlock:s}),o=[];for(const r of i)o.push(...r.transactions);this.addResults(o)}};var $t=Lt;const Ht=Q.Mutex,{createAsyncMiddleware:It,createScaffoldMiddleware:Mt}=O,kt=dt,Tt=bt,vt=$t,{intToHex:D,hexToInt:k}=B;var Ct=Et;function Et({blockTracker:e,provider:t}){let s=0,n={};const i=new Ht,o=At({mutex:i}),r=Mt({eth_newFilter:o(T(l)),eth_newBlockFilter:o(T(d)),eth_newPendingTransactionFilter:o(T(f)),eth_uninstallFilter:o(L(w)),eth_getFilterChanges:o(L(y)),eth_getFilterLogs:o(L(g))}),a=async({oldBlock:c,newBlock:u})=>{if(n.length===0)return;const p=await i.acquire();try{await Promise.all(F(n).map(async h=>{try{await h.update({oldBlock:c,newBlock:u})}catch(I){console.error(I)}}))}catch(h){console.error(h)}p()};return r.newLogFilter=l,r.newBlockFilter=d,r.newPendingTransactionFilter=f,r.uninstallFilter=w,r.getFilterChanges=y,r.getFilterLogs=g,r.destroy=()=>{H()},r;async function l(c){const u=new kt({provider:t,params:c});return await m(u),u}async function d(){const c=new Tt({provider:t});return await m(c),c}async function f(){const c=new vt({provider:t});return await m(c),c}async function y(c){const u=k(c),p=n[u];if(!p)throw new Error(`No filter for index "${u}"`);return p.getChangesAndClear()}async function g(c){const u=k(c),p=n[u];if(!p)throw new Error(`No filter for index "${u}"`);let h=[];return p.type==="log"&&(h=p.getAllResults()),h}async function w(c){const u=k(c),h=!!n[u];return h&&await b(u),h}async function m(c){const u=F(n).length,p=await e.getLatestBlock();await c.initialize({currentBlock:p}),s++,n[s]=c,c.id=s,c.idHex=D(s);const h=F(n).length;return x({prevFilterCount:u,newFilterCount:h}),s}async function b(c){const u=F(n).length;delete n[c];const p=F(n).length;x({prevFilterCount:u,newFilterCount:p})}async function H(){const c=F(n).length;n={},x({prevFilterCount:c,newFilterCount:0})}function x({prevFilterCount:c,newFilterCount:u}){if(c===0&&u>0){e.on("sync",a);return}if(c>0&&u===0){e.removeListener("sync",a);return}}}function T(e){return L(async(...t)=>{const s=await e(...t);return D(s.id)})}function L(e){return It(async(t,s)=>{const n=await e.apply(null,t.params);s.result=n})}function At({mutex:e}){return t=>async(s,n,i,o)=>{(await e.acquire())(),t(s,n,i,o)}}function F(e,t){const s=[];for(let n in e)s.push(e[n]);return s}const Nt=W.default,{createAsyncMiddleware:P,createScaffoldMiddleware:St}=O,_t=Ct,{unsafeRandomBytes:Pt,incrementHexInt:Wt}=B,Ot=E;var ee=jt;function jt({blockTracker:e,provider:t}){const s={},n=_t({blockTracker:e,provider:t});let i=!1;const o=new Nt,r=St({eth_subscribe:P(a),eth_unsubscribe:P(l)});return r.destroy=f,{events:o,middleware:r};async function a(y,g){if(i)throw new Error("SubscriptionManager - attempting to use after destroying");const w=y.params[0],m=Pt(16);let b;switch(w){case"newHeads":b=H({subId:m});break;case"logs":const c=y.params[1],u=await n.newLogFilter(c);b=x({subId:m,filter:u});break;default:throw new Error(`SubscriptionManager - unsupported subscription type "${w}"`)}s[m]=b,g.result=m;return;function H({subId:c}){const u={type:w,destroy:async()=>{e.removeListener("sync",u.update)},update:async({oldBlock:p,newBlock:h})=>{const I=h,U=Wt(p);(await Ot({provider:t,fromBlock:U,toBlock:I})).map(Dt).filter(M=>M!==null).forEach(M=>{d(c,M)})}};return e.on("sync",u.update),u}function x({subId:c,filter:u}){return u.on("update",h=>d(c,h)),{type:w,destroy:async()=>await n.uninstallFilter(u.idHex)}}}async function l(y,g){if(i)throw new Error("SubscriptionManager - attempting to use after destroying");const w=y.params[0],m=s[w];if(!m){g.result=!1;return}delete s[w],await m.destroy(),g.result=!0}function d(y,g){o.emit("notification",{jsonrpc:"2.0",method:"eth_subscription",params:{subscription:y,result:g}})}function f(){o.removeAllListeners();for(const y in s)s[y].destroy(),delete s[y];i=!0}}function Dt(e){return e==null?null:{hash:e.hash,parentHash:e.parentHash,sha3Uncles:e.sha3Uncles,miner:e.miner,stateRoot:e.stateRoot,transactionsRoot:e.transactionsRoot,receiptsRoot:e.receiptsRoot,logsBloom:e.logsBloom,difficulty:e.difficulty,number:e.number,gasLimit:e.gasLimit,gasUsed:e.gasUsed,nonce:e.nonce,mixHash:e.mixHash,timestamp:e.timestamp,extraData:e.extraData}}export{ee as s};
